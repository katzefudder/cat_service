upstream webserver {
    zone upstream-webserver 64k;
    least_conn;
    {{ range service "webserver"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;{{end}}
}

server {
    listen 80 default_server;

    location / {
        proxy_pass http://webserver;
        proxy_set_header  Host $http_host;

        {{ if keyExists "limit_conn" }}
           limit_conn connlimit {{ key "limit_conn" }};
        {{ else }}
            # no limit_conn
        {{ end }}

        {{ if keyExists "limit_rate" }}
           limit_rate {{ key "limit_rate" }};
        {{ else }}
            # no limit_rate
        {{ end }}

    }

    location /nginx_status {
        stub_status;
    }
}

server {
  listen 9145;
  allow 127.0.0.0/24;
  allow 172.16.0.0/16;
  deny all;
  location /metrics {
    content_by_lua '
      metric_connections:set(ngx.var.connections_reading, {"reading"})
      metric_connections:set(ngx.var.connections_waiting, {"waiting"})
      metric_connections:set(ngx.var.connections_writing, {"writing"})
      prometheus:collect()
    ';
  }
}
